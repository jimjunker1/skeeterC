---
title: '`r paste0(Sys.Date()," skeeter forecast")`'
output: pdf_document
---

```{r initiate, echo=FALSE, message=FALSE, warning=FALSE}
# set rmarkdown options
here::i_am("R/skeeter-forecast-template.Rmd")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
## get data
library(tidyverse)
library(forecast)
library(here)
library(kableExtra)
## set options
options(mc.cores = parallel::detectCores())
theme_set(theme_minimal())

## user setting
raft_filepath = sprintf("C:/Users/%s/OneDrive - UNT System/AERI Seed Insect Carbon/Data/2024_aeri_seed_mosquito_data.xlsx", Sys.info()[['user']])

pred_filepath = sprintf("C:/Users/%s/OneDrive - UNT System/Shared Documents - Leaf Litter Hot Moments/General/2024_predictions_aeri_seed_mosquito.xlsx", Sys.info()[['user']])
```

```{r data import}
## this script imports and tidys up raft count data
raft_data = readxl::read_excel(raft_filepath) %>%
  select(-Block, -Mesocosm, -Treatment, -Site)

# identify columns with numbers
raftNumCols = names(raft_data) %>% as.numeric %>% is.na %>% `!`

# rename cols to readible dates
raft_data = raft_data %>%
  rename_with(~as.character(openxlsx::convertToDate(.x, origin='1900-01-01')), .cols = names(.)[raftNumCols])

pred_data = readxl::read_excel(pred_filepath, skip = 1) %>%
  filter(is.na(name) |
         name != 'Total')
predNumCols = names(pred_data) %>% as.numeric %>% is.na %>% `!`

pred_data = pred_data %>%
  rename_with(~as.character(openxlsx::convertToDate(.x, origin='1900-01-01')), .cols = names(.)[predNumCols]) %>% 
  mutate(across(-c(name), as.numeric))

# count_vec = readxl::read_excel(pred_filepath)%>% filter(name == 'Total')
count_df = raft_data %>% select(which(raftNumCols)) %>% colSums(na.rm = FALSE) %>% enframe(name = 'date', value = 'count') %>% 
  mutate(date = as.Date(date))

current_date = as.character(Sys.Date())

name_df = c('GD' = 'Grace',
            'AM' = 'Arya',
            'EAC' = 'Emily',
            'JD' = 'Dr. D',
            'JMR' = 'Julia',
            'JRJ' = 'Jim',
            'JRB' = 'Dr. B',
            'ZC' = 'Z',
            'ARM' = 'Angel',
            'CRG' = 'Chris',
            'JK' = 'Juwan')


```

Good afternoon! Here is your Skeeter report for `r format(Sys.Date(), "%B %d, %Y")`. 

&nbsp;

Today we counted `r count_df %>% filter(date == eval(current_date)) %>% select(count) %>% unlist` skeeter rafts. The closest prediction today was made by 
`r name_df[which.min(abs(pred_data[[eval(current_date)]] - count_df %>% filter(date == eval(current_date)) %>% select(count) %>% unlist %>% unname))]` with a prediction of `r pred_data[which.min(abs(pred_data[[eval(current_date)]] - count_df %>% filter(date == eval(current_date)) %>% select(count) %>% unlist %>% unname)),eval(current_date)]`. Get your predictions in before tomorrow's count for a chance to show off your prediction skills!

```{r time series, fig.align='center', fig.height=4, fig.width=7, fig.cap = "Daily predictions (past = grey circles, current = black circles) and observations (black line) of mosquito rafts counted in mesocosms."}
# create a long plot data frame of predictions
pred_plotDf = pred_data %>% 
  pivot_longer(-name, names_to = 'date', values_to = 'prediction') %>% 
  mutate(date = as.Date(date),
         old = ifelse(as.Date(date)<(Sys.Date()+1), TRUE, FALSE))

# set plotting attributes
ylims = c(0,10^(signif(log10(max(c(count_df$count,na.omit(pred_plotDf$prediction)))))))

labelsDf = data.frame(date = as.numeric(count_df$date), datelab = as.character(format(count_df$date, "%b-%d")), day = paste0("Day ",1:nrow(count_df)))# %>% unite('label', date:day, sep = "") %>% unlist %>% unname

# do the plotting
ggplot()+
  geom_point(data = pred_plotDf, aes(x = as.numeric(date), y = prediction, color = old), shape = 21, fill = 'white', size = 1.2)+
  geom_line(data = count_df , aes(x = as.numeric(date), y = count ), linewidth = 1.1, color = 'black')+
  scale_y_continuous(name = "Skeeter Rafts (#)", limits = ylims)+
  scale_x_continuous(breaks = labelsDf$date, labels = labelsDf$datelab, sec.axis = dup_axis(labels = labelsDf$day))+
  scale_color_manual(values = c('black','darkgrey'))+
  theme(axis.title.x = element_blank(),
        legend.position = 'none',
        axis.text.x.bottom = element_text(size = 10, angle = 45, hjust = 1, vjust = 1),
        axis.text.x.top = element_text(size = 10, angle = 45, hjust = 0, vjust = 0),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
  

```

To measure prediction accuracy, we will calculate the mean absolute error,

$$MAE = \frac{\sum_{i}^{n}|y_{i} - x_{i}|}{n}$$

where, $y_i$ is the prediction, $x_i$ is the observed value, and $n$ is the number of observations.

\newpage

### Rankings

```{r rankings table}
# create prediction accuracy table
pred_accDf = pred_plotDf %>% 
  left_join(count_df, by = 'date') %>% 
  mutate(diff = prediction - count) %>% 
  filter(!is.na(diff)) %>% 
  group_by(name) %>% 
  mutate(MAE = sum(abs(diff))/n()) %>% 
  select(name, date, diff, MAE) %>% 
  arrange(MAE) %>% 
  pivot_wider(id_cols = c(name, MAE), names_from = 'date', values_from = 'diff') %>%
  relocate(MAE, .after = last_col())
  
knitr::kable(pred_accDf, caption = "The rankings to date are:") %>% 
  kableExtra::kable_styling(latex_options = 'scale_down')
```

### Cumulative patterns

```{r cumulative patterns}

cumulative_df = count_df %>% 
  bind_rows(data.frame(date = as.Date("2024-06-26"),
                       count = 0),.) %>% 
  mutate(cumsum = cumsum(count))
 

ylims = c(0, ceiling(max(cumulative_df$cumsum, na.rm = TRUE)/10)*10)

labelsDf = data.frame(date = as.numeric(cumulative_df$date), datelab = as.character(format(cumulative_df$date, "%b-%d")), day = paste0("Day ",0:(nrow(cumulative_df)-1)))

cumulative_df %>% 
  ggplot()+
  geom_line(aes(x = date, y = cumsum), linewidth = 1.1)+
  geom_point(aes(x = date, y = cumsum), color = 'black', size = 1.1)+
  scale_y_continuous(name = "Cumulative Skeeter Rafts (#)", limits = ylims)+
  scale_x_continuous(breaks = labelsDf$date, labels = labelsDf$datelab, sec.axis = dup_axis(labels = labelsDf$day))+
  theme(axis.title.x = element_blank(),
        legend.position = 'none',
        axis.text.x.bottom = element_text(size = 10, angle = 45, hjust = 1, vjust = 1),
        axis.text.x.top = element_text(size = 10, angle = 45, hjust = 0, vjust = 0),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())

```

## Forecasts

Here are a few different models to forecast raft counts for `r Sys.Date()+1`. 

### Previous value

The simplest prediction is to simply predict the previous raft count. 

```{r last value}

lastVal = count_df %>% select(count) %>% unlist %>% is.na %>% `!` %>% which %>% max

ylims = c(0, ceiling(max(count_df$count, na.rm = TRUE)/5)*5)

count_df %>% 
  ggplot()+
  geom_line(data = count_df[c(lastVal, lastVal+1),] %>% fill(count,.direction = 'down'), aes(x = date, y = count), linewidth = 1.2, color = 'grey')+
  geom_point(data = count_df[c(lastVal, lastVal+1),] %>% fill(count,.direction = 'down') %>% slice_tail(n = 1), aes(x = date, y = count), size = 2, color = 'grey')+
  geom_line(aes(x = date, y = count), linewidth = 1.1, color = 'black')+
  geom_point(aes(x = date, y = count), size = 1.2, color = 'black')+
  scale_y_continuous(name = "Skeeter Rafts (#)", limits = ylims)+
  scale_x_continuous(breaks = labelsDf$date, labels = labelsDf$datelab, sec.axis = dup_axis(labels = labelsDf$day))+
  theme(axis.title.x = element_blank(),
        legend.position = 'none',
        axis.text.x.bottom = element_text(size = 10, angle = 45, hjust = 1, vjust = 1),
        axis.text.x.top = element_text(size = 10, angle = 45, hjust = 0, vjust = 0),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
  

```


```{r last value accuracy}

lastVal_accDf = readRDS(here::here("data/lastVal_accDf.rds"))

lastVal = count_df %>% ungroup %>% select(count) %>% unlist %>% is.na %>% `!` %>% which %>% max

lastVal_pred = 
count_df[c(lastVal, lastVal+1),] %>% fill(count,.direction = 'down') %>% slice_tail(n = 1) %>% rename(prediction = 'count')

lastVal_accDf = lastVal_accDf %>% merge(lastVal_pred, by = 'date', all = TRUE) %>% 
  mutate(prediction = coalesce(prediction.x, prediction.y)) %>% 
  select(-prediction.x, -prediction.y)

saveRDS(lastVal_accDf, here::here("data/lastVal_accDf.rds"))
  
  lastVal_accDf %>% 
  mutate(diff = prediction - count) %>% 
  filter(!is.na(diff)) %>% 
  mutate(MAE = sum(abs(diff))/n()) %>% 
  select(date, diff, MAE) %>% 
  arrange(MAE) %>% 
  pivot_wider(id_cols = MAE, names_from = 'date', values_from = 'diff') %>%
  relocate(MAE, .after = last_col()) %>% 
  knitr::kable(caption = "Mean predictive deviation of last value approach") %>% 
  kableExtra::kable_styling(latex_options = 'scale_down')

```

more forecasts to come...
